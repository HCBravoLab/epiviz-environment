<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../epiviz-imports/epiviz-common-js.html">

<dom-module id="epiviz-environment">

    <template>	
	<style>
	:host{
		display: inline-block;
	}
	</style>
    <content id="chartEnv" select=".charts"></content>
</template>

    <script>
        Polymer({
            is: 'epiviz-environment',
            properties: {
                measurements: {
                    type: Object,
                    notify: true,
                    reflectToAttribute: true
                },
                // dataTemp: {
                //     type: Object,
                //     value: {},
                //     notify: true
                // },
                range: {
                    type: Object,
                    notify: true,
                    value: function() {
                        return new epiviz.datatypes.GenomicRange("chr11", 82000000, 9000000);
                    }
                },

                transformData: {
                    type: Boolean,
                    notify: true,
                    value: false
                },

                transformDataFunc: {
                    type: String,
                    notify: true
                }
            },

            // Listeners for interaction between 2 graphs
            listeners: {
                'hover': 'onHover',
                'unHover': 'onUnhover',
                'dimChanged': 'onDimChanged'
            },

            onHover: function(e) {
                // console.log("in onHover of chart-env");
                this.fire('hoverAllCharts', {
                    data: e.detail.data
                });

                // var self = this;

                // var numChildren = self.getEffectiveChildren().length;
                // for (var index = 0; index < numChildren; index++) {
                //     var currentChild = self.getEffectiveChildren()[index];
                //     self.fire('hoverAllCharts', {
                //          data: e.detail.data
                //     }, {
                //         bubbles: false,
                //         node: currentChild
                //     });
                // }
            },

            onUnhover: function(e) {
                // console.log("in onHover of chart-env");
                this.fire('unHoverAllCharts', {
                    data: null
                });

                // var self = this;

                // var numChildren = self.getEffectiveChildren().length;
                // for (var index = 0; index < numChildren; index++) {
                //     var currentChild = self.getEffectiveChildren()[index];
                //     self.fire('unHoverAllCharts', {
                //          data: null
                //     }, {
                //         bubbles: false,
                //         node: currentChild
                //     });
                // }
            },

            onDimChanged: function(e) {
                var chartId = e.detail.id;

                if (chartId != null) {
                    this._updateChart(chartId);
                }
            },

            _generateChartId: function() {
                var chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
                var result = '';
                var size = 7;

                for (var i = 0; i < size; ++i) {
                    result += chars[Math.round(Math.random() * (chars.length - 1))];
                }
                return 'epiviz-' + result;
            },

            _updateChart: function(cId) {

                var self = this;

                var currentChild = Polymer.dom(self).querySelector('[plot-id$="' + cId + '"]');

                var dims = currentChild.dimS || currentChild.getAttribute("dim-s");

                if (typeof(dims) == "string") {
                    dims = JSON.parse(dims);
                }

                var mSet = new epiviz.measurements.MeasurementSet();
                var tMeasurements = [];

                for (var idim = 0; idim < dims.length; idim++) {

                    var mtdx = self.measurements[dims[idim]];

                    mSet.add(new epiviz.measurements.Measurement(
                        mtdx.id,
                        mtdx.name,
                        mtdx.type,
                        mtdx.datasourceId,
                        mtdx.datasourceGroup,
                        mtdx.dataprovider,
                        mtdx.formula,
                        mtdx.defaultChartType,
                        mtdx.annotation,
                        mtdx.minValue,
                        mtdx.maxValue,
                        mtdx.metadata
                    ));

                    tMeasurements.push(mtdx);
                }

                currentChild.measurements = tMeasurements;
                currentChild.range = self.range;

                var chartMeasMap = {};
                chartMeasMap[cId] = mSet;

                var dataManagerElem = Polymer.dom(self).parentNode.querySelector('epiviz-data-source[provider-id$="' + tMeasurements[0].dataprovider + '"]');

                if (dataManagerElem != null) {
                    var dataManager = dataManagerElem.dataManager;

                    dataManager.getData(self.range, chartMeasMap, function(id, data) {
                        //currentChild.data = data;
                        var dataChartElem = Polymer.dom(self).querySelector('[plot-id$="' + id + '"]');

                        dataChartElem.data = self.transformFunc(data);
                    });
                }

            },

            //
            //  output data format 
            //  {
            //      columns: Collection <Object> {measurement-id: <Epiviz measurement>}
            //      values : Array  [measurement-id: Val <Integer>, row: rowInfo]
            //  }
            // TODO: json format
            epivizToJSON: function(data) {

                if(!this.transformData) {
                    return data;
                }

                var fromDataMeasurements = [];
                var range = this.range;

                var firstGlobalIndex = data.firstSeries().globalStartIndex();
                var lastGlobalIndex = data.firstSeries().globalEndIndex();

                data.foreach(function(measurement, series) {
                    fromDataMeasurements.push(measurement);
                    var firstIndex = series.globalStartIndex();
                    var lastIndex = series.globalEndIndex();
                    if (firstIndex > firstGlobalIndex) { firstGlobalIndex = firstIndex; }
                    if (lastIndex < lastGlobalIndex) { lastGlobalIndex = lastIndex; }
                });

                var nItems = lastGlobalIndex - firstGlobalIndex;

                var i, index;
                var grid = {};
                grid.measurements = fromDataMeasurements;
                grid.columns = {};

                grid.measurements.forEach(function(m) {
                    grid.columns[m.datasourceId() + "-" + m.id()] = m;
                });

                grid.values = [];
                var nSeries = fromDataMeasurements.length;
                for (i = 0; i < nItems; ++i) {
                    index = i + firstGlobalIndex;
                    var valArray = {};
                    
                    var row = {};
                    var rowData = data.getSeries(fromDataMeasurements[0]).getRowByGlobalIndex(index);
                    row.start = rowData.start();
                    row.end = rowData.end();
                    row.metadata = rowData.rowMetadata();
                    row.strand = rowData.strand();
                    row.index = rowData.index();
                    row.globalIndex = rowData.globalIndex();
                    row.id = rowData.id();
                    row.seqName = rowData.seqName();
                    valArray.row = row;

                    grid.measurements.forEach(function(m) {
                        var cellX = data.getSeries(m).getByGlobalIndex(index);
                        valArray[m.datasourceId() + "-" + m.id()] = cellX.value;
                    });

                    grid.values.push(valArray);
                }
                return grid;
            },

            attached: function() {

                var self = this;
                // console.log("something is attached");

                if(self.transformDataFunc) {
                    self.transformFunc = new Function('return ' + self.transformDataFunc);
                }
                else {
                    self.transformFunc = self.epivizToJSON;
                }
                
                // var measKeys = Object.keys(this.measurements);

                var numChildren = self.getEffectiveChildren().length;
                for (var index = 0; index < numChildren; index++) {
                    var currentChild = self.getEffectiveChildren()[index];
                    // var tdx = currentChild.dimX || currentChild.getAttribute("dim-x");
                    // var tdy = currentChild.dimY || currentChild.getAttribute("dim-y");

                    // var mtdx = self.measurements[tdx] || null;
                    // var mtdy = self.measurements[tdy] || null;

                    var dims = currentChild.dims || currentChild.getAttribute("dim-s");

                    if (typeof(dims) == "string") {
                        dims = JSON.parse(dims);
                    }

                    var id = self._generateChartId();
                    var mSet = new epiviz.measurements.MeasurementSet();
                    var tMeasurements = [];

                    for (var idim = 0; idim < dims.length; idim++) {

                        var mtdx = self.measurements[dims[idim]];

                        mSet.add(new epiviz.measurements.Measurement(
                            mtdx.id,
                            mtdx.name,
                            mtdx.type,
                            mtdx.datasourceId,
                            mtdx.datasourceGroup,
                            mtdx.dataprovider,
                            mtdx.formula,
                            mtdx.defaultChartType,
                            mtdx.annotation,
                            mtdx.minValue,
                            mtdx.maxValue,
                            mtdx.metadata
                        ));

                        tMeasurements.push(mtdx);
                    }

                    currentChild.plotId = id;
                    currentChild.measurements = tMeasurements;
                    currentChild.range = self.range;

                    var chartMeasMap = {};
                    chartMeasMap[id] = mSet;

                    var dataManagerElem = Polymer.dom(self).parentNode.querySelector('epiviz-data-source[provider-id$="' + tMeasurements[0].dataprovider + '"]');

                    if (dataManagerElem != null) {
                        var dataManager = dataManagerElem.dataManager;

                        dataManager.getData(self.range, chartMeasMap, function(id, data) {
                            //currentChild.data = data;
                            var dataChartElem = Polymer.dom(self).querySelector('[plot-id$="' + id + '"]');

                            dataChartElem.data = self.transformFunc(data);
                        });
                    }

                }

                // measKeys.forEach(function(mk) {
                //     var currMea = self.measurement[mk];

                //     var dataManagerElem = Polymer.dom(self).parentNode.querySelector('epiviz-data-source[provider-id$="' + currMea.dataprovider + '"]');

                //     if (dataManagerElem != null) {
                //         var dataManager = dataManagerElem.dataManager;
                //         console.log(dataManager);
                //         var tempMSet = new epiviz.measurements.MeasurementSet();
                //         var tempMea = new epiviz.measurements.Measurement(
                //             currMea.id,
                //             currMea.name,
                //             currMea.type,
                //             currMea.datasourceId,
                //             currMea.datasourceGroup,
                //             'umd',
                //             null,
                //             null,
                //             null,
                //             currMea.minValue,
                //             currMea.maxValue,
                //             currMea.metadata
                //         );

                //         tempMSet.add(tempMea);

                //         var tM = {};
                //         tM[mk] = tempMSet;
                //         var range = new epiviz.datatypes.GenomicRange("chr11", 80000000, 3000000);
                //         var webProvider = dataManager._dataProviderFactory._providers[currMea.dataprovider];
                //         console.log(webProvider);

                //         var dataRequest = currMea.type == 'range' ? epiviz.data.Request.getRows(tempMea, range) : epiviz.data.Request.getValues(tempMea, range);

                //         console.log(dataRequest);

                //         webProvider.getData(dataRequest, function(data) {
                //             console.log(data);
                //             self[mk] = data._data.values;
                //             self._dataCreated();
                //         });

                //     }

                // });
            },

            ready: function() {
                // console.log("in ready function");
                this.scopeSubtree(this, true);
                var self = this;

                self._observer =
                    Polymer.dom(self.$.chartEnv).observeNodes(function(info) {
                        // self.$.eenv.render();
                        // console.log(info.addedNodes);

                        info.addedNodes.forEach(function(node) {
                            self._updateChart(node.plotId);
                        });

                        // console.log(info.removedNodes);
                });
            }

            // Pre-processing data
            // and bind them to dataX and dataY of chart  
            // _dataCreated: function() {
            //     var self = this;
            //     var numChildren = self.getEffectiveChildren().length;
            //     for (var index = 0; index < numChildren; index++) {
            //         var currentChild = self.getContentChildren('#chartEnv')[index];
            //         var tdx = currentChild.dimX || currentChild.getAttribute("dim-x");
            //         var tdy = currentChild.dimY || currentChild.getAttribute("dim-y");
            //         currentChild.dataX = self[tdx];
            //         currentChild.dataY = self[tdy];
            //     }
            // }

        });
    </script>
</dom-module>